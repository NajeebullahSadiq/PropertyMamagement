<!-- Loading Indicator -->
<div *ngIf="isLoading" class="loading-container">
  <div class="loading-spinner">
    <div class="spinner-ring"></div>
    <div class="spinner-ring"></div>
    <div class="spinner-ring"></div>
  </div>
  <p>در حال بارگذاری معلومات جواز...</p>
</div>

<!-- Error Display -->
<div *ngIf="!isLoading && error" class="error-container">
  <div class="error-icon">⚠</div>
  <p>{{ error }}</p>
</div>

<!-- Main License Page -->
<div class="certificate-page" *ngIf="!isLoading && !error">
  <div class="certificate-wrapper">
    <!-- Watermark Background -->
    <div class="watermark-layer">
      <div class="watermark-circle">
        <div class="watermark-text">
          <div class="watermark-line">{{data.licenseNumber || '—'}}</div>
          <div class="watermark-line">{{data.applicantName || '—'}}</div>
          <div class="watermark-line">{{data.applicantFatherName || '—'}}</div>
          <div class="watermark-line">{{data.licenseIssueDateFormatted || '—'}}</div>
          <div class="watermark-line">{{data.electronicNationalIdNumber || '—'}}</div>
        </div>
      </div>
    </div>

    <!-- Guilloche Pattern Border -->
    <div class="guilloche-border">
      <svg class="guilloche-pattern" viewBox="0 0 100 100" preserveAspectRatio="none">
        <defs>
          <pattern id="guillochePattern" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
            <circle cx="10" cy="10" r="8" fill="none" stroke="rgba(25, 118, 210, 0.15)" stroke-width="0.5" />
            <circle cx="10" cy="10" r="5" fill="none" stroke="rgba(25, 118, 210, 0.1)" stroke-width="0.3" />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#guillochePattern)" />
      </svg>
    </div>

    <!-- Main Certificate Frame -->
    <div class="certificate-frame">
      <!-- Ornate Corner Decorations -->
      <div class="corner-ornament top-right">
        <svg viewBox="0 0 60 60">
          <path d="M0,60 Q0,0 60,0" fill="none" stroke="#1565c0" stroke-width="2" />
          <path d="M5,60 Q5,5 60,5" fill="none" stroke="#42a5f5" stroke-width="1" />
          <circle cx="15" cy="45" r="3" fill="#1976d2" />
          <circle cx="45" cy="15" r="3" fill="#1976d2" />
        </svg>
      </div>
      <div class="corner-ornament top-left">
        <svg viewBox="0 0 60 60">
          <path d="M60,60 Q60,0 0,0" fill="none" stroke="#1565c0" stroke-width="2" />
          <path d="M55,60 Q55,5 0,5" fill="none" stroke="#42a5f5" stroke-width="1" />
          <circle cx="45" cy="45" r="3" fill="#1976d2" />
          <circle cx="15" cy="15" r="3" fill="#1976d2" />
        </svg>
      </div>
      <div class="corner-ornament bottom-right">
        <svg viewBox="0 0 60 60">
          <path d="M0,0 Q0,60 60,60" fill="none" stroke="#1565c0" stroke-width="2" />
          <path d="M5,0 Q5,55 60,55" fill="none" stroke="#42a5f5" stroke-width="1" />
          <circle cx="15" cy="15" r="3" fill="#1976d2" />
          <circle cx="45" cy="45" r="3" fill="#1976d2" />
        </svg>
      </div>
      <div class="corner-ornament bottom-left">
        <svg viewBox="0 0 60 60">
          <path d="M60,0 Q60,60 0,60" fill="none" stroke="#1565c0" stroke-width="2" />
          <path d="M55,0 Q55,55 0,55" fill="none" stroke="#42a5f5" stroke-width="1" />
          <circle cx="45" cy="15" r="3" fill="#1976d2" />
          <circle cx="15" cy="45" r="3" fill="#1976d2" />
        </svg>
      </div>

      <!-- Certificate Content -->
      <div class="certificate-content" dir="rtl">
        <!-- Header Section -->
        <header class="certificate-header">
          <!-- Right Column: National Emblem & License Info -->
          <div class="header-right">
            <div class="emblem-container">
              <img src="/assets/img/afg.png" alt="نشان ملی افغانستان" class="national-emblem">
            </div>
            <div class="license-meta">
              <div class="meta-item">
                <span class="meta-label">نمبر جواز:</span>
                <span class="meta-value">{{ data.licenseNumber }}</span>
              </div>
              <div class="meta-item">
                <span class="meta-label">تاریخ صدور:</span>
                <span class="meta-value">{{ data.licenseIssueDateFormatted || '-' }}</span>
              </div>
            </div>
          </div>

          <!-- Center Column: Ministry Info -->
          <div class="header-center">
            <h1 class="ministry-title">امارت اسلامی افغانستان</h1>
            <div class="ministry-divider">
              <span class="divider-line"></span>
              <span class="divider-diamond">◆</span>
              <span class="divider-line"></span>
            </div>
            <h2 class="ministry-name">وزارت عدلیه</h2>
            <h3 class="department-name">ریاست عمومی انسجام</h3>
            <h4 class="sub-department">ریاست امور رهنمای معاملات و عریضه نویسان</h4>
            <h4 class="sub-department">آمریت رهنمای معاملات و عریضه نویسان</h4>
            <h4 class="sub-department">مدیریت بررسی و ثبت جواز عریضه نویسان</h4>
          </div>

          <!-- Left Column: Logo & Photo -->
          <div class="header-left">
            <div class="logo-photo-stack">
              <img src="/assets/img/mcitlogo.png" alt="لوگو وزارت" class="ministry-logo">
              <div class="photo-container">
                <div class="photo-frame">
                  <img *ngIf="data.picturePath" [src]="getImageUrl(data.picturePath)" alt="عکس" class="owner-photo"
                    onerror="this.src='assets/img/avatar.png'">
                  <img *ngIf="!data.picturePath" src="assets/img/avatar.png" alt="عکس" class="owner-photo">
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main Body -->
        <main class="certificate-body">
          <!-- Main Data Table -->
          <table class="data-table">
            <thead>
              <tr>
                <th colspan="2" class="table-header">شهرت و سکونت اصلی</th>
                <th colspan="2" class="table-header">سکونت فعلی</th>
                <th colspan="2" class="table-header">محل فعالیت</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="table-label">نام و تخلص</td>
                <td class="table-value">{{ data.applicantName || '-' }}</td>
                <td class="table-label">ولایت</td>
                <td class="table-value">{{ data.currentProvinceName || '-' }}</td>
                <td class="table-label">ناحیه</td>
                <td class="table-value">{{ data.district || '-' }}</td>
              </tr>
              <tr>
                <td class="table-label">ولد</td>
                <td class="table-value">{{ data.applicantFatherName || '-' }}</td>
                <td class="table-label">ولسوالی</td>
                <td class="table-value">{{ data.currentDistrictName || '-' }}</td>
                <td class="table-label">ادرس دقیق</td>
                <td class="table-value">{{ data.detailedAddress || '-' }}</td>
              </tr>
              <tr>
                <td class="table-label">نمبر تذکره</td>
                <td class="table-value">{{ data.electronicNationalIdNumber || '-' }}</td>
                <td class="table-label">ناحیه</td>
                <td class="table-value">{{ data.currentVillage || '-' }}</td>
                <td class="table-label">نقل مکان</td>
                <td class="table-value">{{ getLatestRelocation() }}</td>
              </tr>
              <tr>
                <td class="table-label">ولایت</td>
                <td class="table-value">{{ data.permanentProvinceName || '-' }}</td>
                <td class="table-label">قریه / گذر</td>
                <td class="table-value">{{ data.currentVillage || '-' }}</td>
                <td class="table-label"></td>
                <td class="table-value"></td>
              </tr>
              <tr>
                <td class="table-label">ولسوالی</td>
                <td class="table-value">{{ data.permanentDistrictName || '-' }}</td>
                <td class="table-label">شماره تماس</td>
                <td class="table-value">{{ data.mobileNumber || '-' }}</td>
                <td class="table-label"></td>
                <td class="table-value"></td>
              </tr>
              <tr>
                <td class="table-label">ناحیه / قریه</td>
                <td class="table-value">{{ data.permanentVillage || '-' }}</td>
                <td class="table-label"></td>
                <td class="table-value"></td>
                <td class="table-label"></td>
                <td class="table-value"></td>
              </tr>
            </tbody>
          </table>

          <!-- Bottom Three Columns Table -->
          <table class="bottom-table">
            <thead>
              <tr>
                <th class="bottom-header">معلومات جواز عریضه نویسی</th>
                <th class="bottom-header">نظر به درمورد</th>
                <th class="bottom-header">مرجع صلاحیت و امضاء</th>

              </tr>
            </thead>
            <tbody>
              <tr>
                 <td class="bottom-cell">
                  <div class="info-row">
                    <span>اعتبار از تاریخ:</span>
                    <span class="info-value">{{ data.licenseIssueDateFormatted || '-' }}</span>
                  </div>
                  <div class="info-row">
                    <span>الی:</span>
                    <span class="info-value">{{ data.licenseExpiryDateFormatted || '-' }}</span>
                  </div>
                </td>
                <td class="bottom-cell">
                  <div class="bottom-text-justify">
                    در اهلیت عریضه نویسی بعد از اخذ امتحان نظر هیئت داده شد، که این عریضه نویس به درجه {{
                    getCompetencyName() }} لیاقت و اهلیت دارد.
                  </div>
                  <div class="bottom-text-center">مهر</div>
                </td>
               
                <td class="bottom-cell">
                  <div class="bottom-text-center">ریاست عمومی انسجام</div>
                  <div class="signature-space"></div>
                  <div class="bottom-text-center">امضاء رئیس</div>
                </td>
              </tr>
            </tbody>
          </table>
        </main>

        <!-- Footer Section -->
        <footer class="certificate-footer">
          <!-- QR Code Verification Row -->
          <div class="verification-row" *ngIf="verificationCode">
            <div class="qr-code-container">
              <img [src]="qrCodeUrl" alt="QR Code" class="qr-code" *ngIf="qrCodeUrl">
            </div>
            <div class="verification-details">
              <div class="verification-item">
                <span class="verification-label">کود تصدیق سند:</span>
                <span class="verification-code">{{ verificationCode }}</span>
              </div>
              <div class="verification-item">
                <span class="verification-label">شهرت:</span>
                <span class="verification-value">{{ data.applicantName || '—' }}</span>
              </div>
            </div>
          </div>

          <!-- Verification Error -->
          <div class="verification-row error" *ngIf="verificationError && !verificationCode">
            <div class="error-content">
              <span class="error-text">{{ verificationError }}</span>
              <span class="verification-label">برای تصدیق با اداره تماس بگیرید</span>
            </div>
          </div>
        </footer>
      </div>
    </div>
  </div>
</div>