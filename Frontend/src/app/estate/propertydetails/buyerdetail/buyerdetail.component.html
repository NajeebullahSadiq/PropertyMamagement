<section>
    <div class="container">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col-lg-12 col-xl-11">
                <div class="card text-black" style="border-radius: 25px;">
                    <div class="card-body p-md-5">

                        <div class="heading-wrapper">
                            <img [src]="imagePath" class="seller-image" alt="Buyer Image">

                            <p class="text-center h2 fw-bold mb-5 mx-1 mx-md-4 mt-4">ثبت مشخصات مشتری ملکیت</p>
                        </div>
                        <app-profile-image-cropper
                          #childComponent
                          [initialImageUrl]="imagePath"
                          documentType="profile"
                          [roundCropper]="true"
                          (imageChanged)="profilePreviewChanged($event)"
                          (imageUploaded)="profileImageUploaded($event)"
                          style="text-align:left;"
                        ></app-profile-image-cropper>
                        
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h5 style="font-weight: bold; color: #007bff;">آپلود تذکره ملی (الزامی)</h5>
                                <app-nationalid-upload #nationalIdComponent (sendMessage)="nationalIdUploadFinished($event)" style="text-align:left;"></app-nationalid-upload>
                                <div *ngIf="nationalIdCard?.invalid && (nationalIdCard?.dirty || nationalIdCard?.touched)">
                                    <small class="text-danger" *ngIf="nationalIdCard?.errors?.['required']">آپلود تذکره ملی الزامی است</small>
                                </div>
                            </div>
                        </div>

                        <form [formGroup]="sellerForm"
                            (ngSubmit)="sellerForm.valid ? selectedSellerId ? updateBuyerDetails() : addBuyerDetail() : null">
                            <div class="form-group">
                                <input type="hidden" formControlName="id">
                            </div>

                            <!-- Duplicate Error Message -->
                            <div class="row" *ngIf="duplicateError">
                                <div class="col-md-12">
                                    <div class="alert alert-danger alert-dismissible fade show" role="alert" style="border-left: 4px solid #dc3545; font-weight: 500;">
                                        <i class="fas fa-exclamation-circle" style="margin-left: 8px;"></i>
                                        {{ duplicateError }}
                                        <button type="button" class="btn-close" (click)="duplicateError = ''" aria-label="Close"></button>
                                    </div>
                                </div>
                            </div>

                            <!-- Role Type Selection -->
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="roleType" class="form-label">نوعیت عاقد</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-user-tag"></i></span>
                                        <select id="roleType" class="form-control" formControlName="roleType">
                                            <option *ngFor="let role of roleTypes" [value]="role.value">{{ role.label }}</option>
                                        </select>
                                    </div>
                                    <div *ngIf="roleType?.invalid && (roleType?.dirty || roleType?.touched)">
                                        <small class="text-danger" *ngIf="roleType?.errors?.['required']">این فیلد الزامی است</small>
                                    </div>
                                </div>
                                <div class="col-md-6" *ngIf="allowsMultipleBuyers()">
                                    <div class="alert alert-info" style="margin-top: 32px; padding: 8px 12px">
                                        <i class="fas fa-info-circle" style="margin-left: 5px"></i>
                                        <strong>می‌توانید چندین خریدار اضافه کنید</strong>
                                    </div>
                                </div>
                                <div class="col-md-6" *ngIf="isSingularRole()">
                                    <div class="alert alert-warning" style="margin-top: 32px; padding: 8px 12px">
                                        <i class="fas fa-exclamation-triangle" style="margin-left: 5px"></i>
                                        <strong>فقط یک خریدار مجاز است</strong>
                                    </div>
                                </div>
                            </div>

                            <!-- Conditional Authorization Letter Upload -->
                            <div class="row mt-3" *ngIf="isAuthorizedAgent()">
                                <div class="col-md-12">
                                    <h5 style="font-weight: bold; color: #dc3545;">آپلود وکالت نامه (الزامی)</h5>
                                    <app-upload #authLetterComponent (sendMessage)="authorizationLetterUploadFinished($event)" style="text-align:left;"></app-upload>
                                    <div *ngIf="authorizationLetter?.invalid && (authorizationLetter?.dirty || authorizationLetter?.touched)">
                                        <small class="text-danger" *ngIf="authorizationLetter?.errors?.['required']">آپلود وکالت نامه الزامی است</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Conditional Rental Dates for Lessee Roles -->
                            <div class="row mt-3" *ngIf="isLesseeRole()">
                                <div class="col-md-6">
                                    <label for="rentStartDate" class="form-label">تاریخ شروع کرایه</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <input type="date" id="rentStartDate" class="form-control" formControlName="rentStartDate">
                                    </div>
                                    <div *ngIf="rentStartDate?.invalid && (rentStartDate?.dirty || rentStartDate?.touched)">
                                        <small class="text-danger" *ngIf="rentStartDate?.errors?.['required']">تاریخ شروع کرایه الزامی است</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="rentEndDate" class="form-label">تاریخ ختم کرایه</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                        <input type="date" id="rentEndDate" class="form-control" formControlName="rentEndDate">
                                    </div>
                                    <div *ngIf="rentEndDate?.invalid && (rentEndDate?.dirty || rentEndDate?.touched)">
                                        <small class="text-danger" *ngIf="rentEndDate?.errors?.['required']">تاریخ ختم کرایه الزامی است</small>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <label for="firstName" class="form-label">نام </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text" id="firstName" class="form-control"
                                            formControlName="firstName">
                                        <div *ngIf="firstName?.invalid && (firstName?.dirty || firstName?.touched)">
                                            <small class="text-danger" *ngIf="firstName?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="fatherName" class="form-label">نام پدر </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text" id="fatherName" class="form-control"
                                            formControlName="fatherName">
                                        <div *ngIf="fatherName?.invalid && (fatherName?.dirty || fatherName?.touched)">
                                            <small class="text-danger" *ngIf="fatherName?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>

                            </div>


                            <div class="row">
                                <div class="col-md-4">
                                    <label for="grandFather" class="form-label">نام پدر کلان</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text" id="grandFather" class="form-control"
                                            formControlName="grandFather">
                                        <div *ngIf="grandFather?.invalid && (grandFather?.dirty || grandFather?.touched)">
                                            <small class="text-danger" *ngIf="grandFather?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="indentityCardNumber" class="form-label"> شماره تذکره</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text"  (keypress)="onlyNumberKey($event)" id="indentityCardNumber" class="form-control"
                                            formControlName="indentityCardNumber">
                                        <div *ngIf="indentityCardNumber?.invalid && (indentityCardNumber?.dirty || indentityCardNumber?.touched)">
                                            <small class="text-danger" *ngIf="indentityCardNumber?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label for="phoneNumber" class="form-label"> شماره موبایل</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text"  (keypress)="onlyNumberKey($event)" id="phoneNumber" class="form-control"
                                            formControlName="phoneNumber">
                                        <div *ngIf="phoneNumber?.invalid && (phoneNumber?.dirty || phoneNumber?.touched)">
                                            <small class="text-danger" *ngIf="phoneNumber?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                                </div>
                                <br>
                                <section>
                                    <div class="row d-flex justify-content-center align-items-center h-100">
                                    <h3 style="font-weight: bold;"> سکونت اصلی</h3>
                                <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label me-3"> ولایت</label>
                                    <ng-select formControlName="paddressProvinceId" [items]="province" [selectOnTab]="true"
                                      bindLabel="dari" bindValue="id" (change)="filterResults($event)">
                                    </ng-select>
                                  </div>
                                <div class="col-md-4">
                                    <label class="form-label me-3"> ناحیه/ولسوالی</label>
                                    <ng-select formControlName="paddressDistrictId" [items]="district" [selectOnTab]="true"
                                      bindLabel="dari" bindValue="id">
                                    </ng-select>
                                  </div>
                                <div class="col-md-4">
                                    <label for="paddressVillage" class="form-label"> قریهګذر / قریه / ادرس بلاک</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text" id="paddressVillage" class="form-control"
                                            formControlName="paddressVillage">
                                        <div *ngIf="paddressVillage?.invalid && (paddressVillage?.dirty || paddressVillage?.touched)">
                                            <small class="text-danger" *ngIf="paddressVillage?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                          </div>
                        </section>
                        <br>
                        <section>

                            <div class="row">
                                <div class="row d-flex justify-content-center align-items-center h-100">
                                    <h3 style="font-weight: bold;"> سکونت فعلی</h3>


                                <div class="col-md-4">
                                    <label class="form-label me-3"> ولایت </label>
                                    <ng-select formControlName="taddressProvinceId" [items]="province" [selectOnTab]="true"
                                      bindLabel="dari" bindValue="id" (change)="filterResults2($event)">
                                    </ng-select>

                                  </div>

                                <div class="col-md-4">
                                    <label class="form-label me-3"> ناحیه/ولسوالی</label>
                                    <ng-select formControlName="taddressDistrictId" [items]="district2" [selectOnTab]="true"
                                      bindLabel="dari" bindValue="id">
                                    </ng-select>

                                  </div>
                                <div class="col-md-4">
                                    <label for="taddressVillage" class="form-label"> ګذر / قریه / ادرس بلاک </label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-file-alt"></i></span>
                                        <input type="text" id="taddressVillage" class="form-control"
                                            formControlName="taddressVillage">
                                        <div *ngIf="taddressVillage?.invalid && (taddressVillage?.dirty || taddressVillage?.touched)">
                                            <small class="text-danger" *ngIf="taddressVillage?.errors?.['required']">این فیلد
                                                الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        </section>
                        <br>
                        <section>
                            <div class="row d-flex justify-content-center align-items-center h-100">
                                <h3 style="font-weight: bold;">معلومات معاملہ</h3>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label me-3">نوعیت ملکیت</label>
                                        <ng-select formControlName="propertyTypeId" [items]="localizedPropertyTypes" [selectOnTab]="true"
                                          bindLabel="name" bindValue="id">
                                        </ng-select>
                                        <div *ngIf="propertyTypeId?.invalid && (propertyTypeId?.dirty || propertyTypeId?.touched)">
                                            <small class="text-danger" *ngIf="propertyTypeId?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4" *ngIf="isOtherPropertyType()">
                                        <label for="customPropertyType" class="form-label">نوع ملکیت (سایر)</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-edit"></i></span>
                                            <input type="text" id="customPropertyType" class="form-control" formControlName="customPropertyType" placeholder="نوع ملکیت را وارد کنید">
                                        </div>
                                        <div *ngIf="customPropertyType?.invalid && (customPropertyType?.dirty || customPropertyType?.touched)">
                                            <small class="text-danger" *ngIf="customPropertyType?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label me-3">نوعیت معامله</label>
                                        <ng-select formControlName="transactionType" [items]="transactionTypes" [selectOnTab]="true"
                                          bindLabel="label" bindValue="value">
                                        </ng-select>
                                        <div *ngIf="transactionType?.invalid && (transactionType?.dirty || transactionType?.touched)">
                                            <small class="text-danger" *ngIf="transactionType?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4" *ngIf="isOtherTransactionType()">
                                        <label for="transactionTypeDescription" class="form-label">توضیح سایر</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-edit"></i></span>
                                            <input type="text" id="transactionTypeDescription" class="form-control" formControlName="transactionTypeDescription">
                                        </div>
                                        <div *ngIf="transactionTypeDescription?.invalid && (transactionTypeDescription?.dirty || transactionTypeDescription?.touched)">
                                            <small class="text-danger" *ngIf="transactionTypeDescription?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4" *ngIf="showPriceFields()">
                                        <label for="price" class="form-label">{{ getPriceNumberLabel() }}</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-money-bill-alt"></i></span>
                                            <input type="number" (keypress)="onlyNumberKey($event)" id="price" class="form-control" formControlName="price">
                                        </div>
                                        <div *ngIf="price?.invalid && (price?.dirty || price?.touched)">
                                            <small class="text-danger" *ngIf="price?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4" *ngIf="showPriceFields()">
                                        <label for="priceText" class="form-label">{{ getPriceTextLabel() }}</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-money-bill-alt"></i></span>
                                            <input type="text" id="priceText" class="form-control" formControlName="priceText">
                                        </div>
                                        <div *ngIf="priceText?.invalid && (priceText?.dirty || priceText?.touched)">
                                            <small class="text-danger" *ngIf="priceText?.errors?.['required']">این فیلد الزامی است</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="royaltyAmount" class="form-label">مبلغ حق ‌العمل رهنمای معاملات </label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-money-bill-alt"></i></span>
                                            <input type="number" id="royaltyAmount" class="form-control" formControlName="royaltyAmount" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="halfPrice" class="form-label">مناصفه قیمت</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="fas fa-money-bill-alt"></i></span>
                                            <input type="number" id="halfPrice" class="form-control" formControlName="halfPrice" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <br>
                        <button type="submit" [disabled]="sellerForm.invalid" class="btn btn-success">{{selectedSellerId ?
                          'تغیر معلومات' : 'ثبت معلومات'}}</button>
                        <button type="reset"  class="btn btn-primary"
                        style="margin-right: 5px;" (click)="resetChild()">جدید</button>
                        <button
                          type="button"
                          *ngIf="allowsMultipleBuyers() && sellerDetails && sellerDetails.length > 0"
                          class="btn btn-info"
                          style="margin-right: 5px"
                          (click)="onNextClick()"
                        >
                          <i class="fas fa-arrow-left" style="margin-left: 5px"></i>مرحله بعدی
                        </button>
                        </form>
                    </div>
                </div>
                <br>
                <div class="container">
                <table class="table table-bordered">
                    <thead>
                      <tr style="text-align: center;">
                        <th> آی دی</th>
                        <th>نام</th>
                        <th>نام پدر</th>
                        <th>نام پدر کلان</th>
                        <th>شماره تذکره</th>
                        <th>شماره موبایل</th>
                        <th>نوعیت عاقد</th>
                        <th>عملیات</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let b of sellerDetails" style="text-align: center;">
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.id }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.firstName }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.fatherName }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.grandFather }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.indentityCardNumber }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ b.phoneNumber }}</td>
                        <td (click)="BindValue(b.id)" style="cursor: pointer;">{{ getRoleTypeLabel(b.roleType) }}</td>
                        <td>
                          <button class="btn btn-danger btn-sm" (click)="deleteBuyer(b.id)">حذف</button>
                        </td>
                      </tr>
                      <tr *ngIf="!sellerDetails || sellerDetails.length === 0">
                        <td colspan="8" style="text-align: center;">هیچ خریداری ثبت نشده است</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
            </div>
        </div>
    </div>
</section>
